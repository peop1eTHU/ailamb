<!DOCTYPE html>
<html>
<head>
    <title>å…‰è¯­ä¼´å­¦</title>
    <style>
        body {
            display: block; /* å–æ¶ˆ flex å¸ƒå±€ */
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
        }
        .left-panel, .right-panel {
            max-width: none; /* å–æ¶ˆå®½åº¦é™åˆ¶ */
        }
        .left-panel {
            float: left;
            width: 70%;
            padding-right: 20px;
        }
        .right-panel {
            float: left;
            width: 25%;
        }
        #videoStream {
            width: 100%;
            height: auto;
            border: 2px solid #333;
            background: #000;
        }

        /* ç«–å±å±•ç¤ºæ ·å¼
        .vertical-container {
        width: 480px;
        height: 720px;
        margin: 0 auto;
        overflow: hidden;
        border: 2px solid #333;
        } */

        #videoStream {
        width: 100%;
        height: 100%;
        object-fit: cover;  /* ä¿æŒæ¯”ä¾‹å¡«å……å®¹å™¨ */
        
        /* å¦‚æœæ‘„åƒå¤´æ— æ³•ç¡¬ä»¶æ—‹è½¬ï¼Œæ·»åŠ CSSæ—‹è½¬ */
        /* transform: rotate(90deg);
        transform-origin: center center; */
        }
        .button {
            padding: 10px 20px;
            margin: 10px 5px;
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }
        .button:hover {
            background: #45a049;
        }
        .snapshot-list {
            max-height: 80vh;
            overflow-y: auto;
        }
        .snapshot-item {
            margin: 10px 0;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .snapshot-item:hover {
            transform: scale(1.05);
        }
        .snapshot-item img {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .tab-nav {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        .tab-button {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            transition: all 0s;
        }
        .tab-button.active {
            color: #4CAF50;
            border-bottom: 3px solid #4CAF50;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }



        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        /* ç«–å±è§†é¢‘é¢„è§ˆåŒº */
        .preview-section {
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            height: 720px;
        }
        #videoFeed {
            width: 100%;
            height: 70%;
            transform: rotate(90deg) scale(1.4); /* å…³é”®æ—‹è½¬ä»£ç  */
            transform-origin: center;
            object-fit: cover;
        }

        /* æ§åˆ¶æŒ‰é’®ç»„ */
        .controls {
            margin-top: 20px;
            text-align: center;
        }
        .btn {
            padding: 12px 24px;
            margin: 0 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #45a049;
            transform: scale(1.05);
        }

        /* ç¼©ç•¥å›¾åˆ—è¡¨ */
        .thumbnails {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            max-height: 720px;
            overflow-y: auto;
        }
        .thumbnail-item {
            margin-bottom: 15px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        .thumbnail-item.active {
            border-color: #4CAF50;
        }
        .thumbnail-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 5px;
        }

    </style>
    <style>
        .homework-container {
            display: flex;
            gap: 20px;
            padding: 20px;
        }
        .pdf-preview {
            flex: 1;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .homework-control {
            flex: 1;
            max-width: 400px;
        }
        .homework-list {
            margin-top: 15px;
            border: 1px solid #ddd;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        .homework-item {
            padding: 10px;
            margin: 5px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .homework-item.selected {
            background: #f0faff;
            border-left: 4px solid #2196F3;
        }
    </style>
    <style>
        .music-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .upload-section {
            margin-bottom: 20px;
        }
        .control-panel {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .playlist {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .track-item {
            padding: 10px;
            margin: 5px 0;
            cursor: pointer;
            transition: background 0.3s;
        }
        .track-item:hover {
            background: #e0f0ff;
        }
    </style>
    <style>
        .study-container {
            display: flex;
            gap: 20px;
            padding: 20px;
        }
        .study-control-panel {
            flex: 1;
            min-width: 300px;
            max-width: 300px;
        }
        .status-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .interval-control {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 10px;
        }
        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .photo-item:hover {
            transform: translateY(-5px);
        }
        .photo-item img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }
        .photo-date {
            position: absolute;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            width: 100%;
            padding: 5px;
            font-size: 12px;
        }
    </style>
    <style>
        .pomodoro-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        .status-card {
            background: #fff;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }
        .time-display {
            font-size: 72px;
            font-weight: bold;
            color: #e74c3c;
            margin: 20px 0;
        }
        .phase-indicator {
            font-size: 24px;
            color: #2ecc71;
            margin-bottom: 15px;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            color: #7f8c8d;
        }
        .pomo-btn {
            padding: 12px 30px;
            margin: 0 10px;
            border: none;
            border-radius: 25px;
            background: #3498db;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .pomo-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
        .settings-panel {
            margin-top: 30px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        .setting-item {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .setting-item input {
            padding: 8px;
            width: 80px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>


    <style>
        .edu-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            height: 80vh;
        }

        .preview-pane {
            background: #f0f0f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .operation-pane {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .login-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .form-group {
            margin: 15px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .assignment-list {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .assignment-item {
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #eee;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .assignment-item:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .assignment-item.selected {
            border-color: #4CAF50;
            background: #f0fff4;
        }
    </style>

</head>
<body>
    <!-- é€‰é¡¹å¡å¯¼èˆª -->
    <div class="tab-nav">
        <button id="camerabut" class="tab-button active" onclick="switchTab('camera')">æ‹æ‘„ä½œä¸š</button>
        <button id="homeworkbut" class="tab-button" onclick="switchTab('homework')">ä½œä¸šæäº¤</button>
        <button id="ledbut" class="tab-button" onclick="switchTab('led')">å€’è®¡æ—¶</button>
        <button id="pomodorobut" class="tab-button" onclick="switchTab('pomodoro')">ç•ªèŒ„æ—¶é’Ÿ</button>    
        <button id="musicbut" class="tab-button" onclick="switchTab('music')">éŸ³ä¹æ’­æ”¾</button>
        <button id="studybut" class="tab-button" onclick="switchTab('study')">å­¦ä¹ è®°å½•</button>
    </div>

    <!-- åˆ†é¡µå†…å®¹ -->
    <div id="cameraTab" class="tab-content active">

        <div class="container">
            <!-- å·¦ä¾§ä¸»æ“ä½œåŒº -->
            <div class="preview-section">
                <img id="videoFeed" src="http://192.168.3.62:8080/?action=stream">
            </div>

            <!-- å³ä¾§æ§åˆ¶é¢æ¿ -->
            <div class="control-panel">
                <div class="controls">
                    <button class="btn" onclick="captureSnapshot()">æ‹æ‘„</button>
                    <button class="btn" onclick="downloadPDF()">ç”ŸæˆPDF</button>
                </div>

                <div class="thumbnails">
                    <h3>å·²æ‹æ‘„çš„å¿«ç…§</h3>
                    <div class="snapshot-list" id="snapshotList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç•ªèŒ„æ—¶é’Ÿé¡µé¢ -->
    <div id="pomodoroTab" class="tab-content">
        <div class="pomodoro-container">
            <!-- çŠ¶æ€æ˜¾ç¤º -->
            <div class="status-card">
                <div class="time-display" id="timeDisplay">25:00</div>
                <div class="phase-indicator" id="phaseIndicator">å‡†å¤‡å¼€å§‹</div>
                <div class="stats">
                    <span>å·²å®Œæˆç•ªèŒ„: <span id="tomatoCount">0</span></span>
                    <span>å½“å‰å‘¨æœŸ: <span id="cycleCount">0</span></span>
                </div>
            </div>

            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="control-panel">
                <button class="pomo-btn" onclick="controlPomodoro('start')" id="startBtn">å¼€å§‹</button>
                <button class="pomo-btn" onclick="controlPomodoro('pause')">æš‚åœ</button>
                <button class="pomo-btn" onclick="controlPomodoro('reset')">é‡ç½®</button>
            </div>

            <!-- è®¾ç½®é¢æ¿ -->
            <div class="settings-panel">
                <h3>âš™ï¸ æ—¶é—´è®¾ç½®</h3>
                <div class="setting-item">
                    <label>ä¸“æ³¨æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
                    <input type="number" id="workTime" value="25" min="1">
                </div>
                <div class="setting-item">
                    <label>ä¼‘æ¯æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
                    <input type="number" id="breakTime" value="5" min="1">
                </div>
                <button class="button" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
            </div>
        </div>
    </div>

    <div id="ledTab" class="tab-content">
        <!-- æ–°å¢ LED æ§åˆ¶å†…å®¹ -->
        <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
            <h2>å€’è®¡æ—¶</h2>
            <input type="number" id="timerDuration" placeholder="è¾“å…¥å€’è®¡æ—¶ï¼ˆç§’ï¼‰" min="1" style="padding: 8px; width: 200px;">
            <button class="button" onclick="startTimer()">å¼€å§‹å€’è®¡æ—¶</button>
            <div id="timerDisplay" style="margin: 15px 0; font-size: 24px; color: #333;">00:00</div>
            <button class="button" onclick="manualToggleLed()">é‡ç½®</button>
        </div>
    </div>


    <div id="homeworkTab" class="tab-content">
        <div class="edu-container">
            <!-- å·¦ä¾§PDFé¢„è§ˆ -->
            <div class="preview-pane">
                <iframe id="pdfPreview" 
                    src="/static/snapshots/output.pdf"
                    width="100%" 
                    height="600px"></iframe>
            </div>

            <!-- å³ä¾§æ“ä½œåŒº -->
            <div class="operation-pane">
                <!-- ç™»å½•åŒºåŸŸ -->
                <div class="login-box">
                    <h3>ç½‘ç»œå­¦å ‚ç™»å½•</h3>
                    <div class="form-group">
                        <label>ç”¨æˆ·åï¼š</label>
                        <input type="text" id="eduUser" placeholder="å­¦å·/é‚®ç®±">
                    </div>
                    <div class="form-group">
                        <label>å¯†ç ï¼š</label>
                        <input type="password" id="eduPass">
                    </div>
                    <button class="btn" onclick="eduLogin()">ç™»å½•</button>
                    <div id="loginStatus"></div>
                </div>

                <!-- ä½œä¸šåˆ—è¡¨ -->
                <div class="assignment-list" id="assignmentList">
                    <h3>æœªæäº¤ä½œä¸š</h3>
                    <div class="list-container"></div>
                </div>

                <!-- æäº¤æ“ä½œ -->
                <div class="submit-box">
                    <button class="btn" onclick="submitAssignment()">æäº¤é€‰ä¸­ä½œä¸š</button>
                    <div id="submitStatus"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="musicTab" class="tab-content">
        <div class="music-container">
            <!-- ä¸Šä¼ æ¨¡å— -->
            <div class="upload-section">
                <input type="file" id="musicUpload" accept=".mp3,.wav,.ogg,.flac">
                <button class="button" onclick="uploadMusic()">ä¸Šä¼ éŸ³ä¹</button>
            </div>

            <!-- æ’­æ”¾æ§åˆ¶ -->
            <div class="control-panel">
                <div class="now-playing">
                    <h3>å½“å‰æ’­æ”¾ï¼š<span id="currentTrack">æ— </span></h3>
                    <p>çŠ¶æ€ï¼š<span id="playStatus">åœæ­¢</span></p>
                </div>
                <div class="buttons">
                    <button class="button" onclick="control('play')">â–¶ æ’­æ”¾</button>
                    <button class="button" onclick="control('pause')">â¸ æš‚åœ</button>
                    <button class="button" onclick="control('stop')">â¹ åœæ­¢</button>
                    <input type="range" id="volume" min="0" max="1" step="0.1" 
                        value="1" oninput="setVolume(this.value)">
                </div>
            </div>

            <!-- æ’­æ”¾åˆ—è¡¨ -->
            <div class="playlist">
                <h3>æœåŠ¡å™¨éŸ³ä¹åˆ—è¡¨</h3>
                <div id="musicList"></div>
            </div>
        </div>
    </div>

    <div id="studyTab" class="tab-content">
        <div class="study-container">
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="study-control-panel">
                <div class="status-card">
                    <h3>å®šæ—¶æ‹ç…§çŠ¶æ€ï¼š<span id="captureStatus">å·²åœæ­¢</span></h3>
                    <div class="interval-control">
                        <input type="number" id="intervalInput" 
                            min="1" value="5" style="width: 80px;">
                        <span>åˆ†é’Ÿé—´éš”</span>
                        <button class="button" onclick="setsetInterval()">è®¾ç½®</button>
                    </div>
                    <div class="action-buttons">
                        <button class="button" onclick="toggleCapture()" 
                                id="toggleBtn">å¼€å¯å®šæ—¶</button>
                        <button class="button" onclick="captureNow()">ç«‹å³æ‹ç…§</button>
                    </div>
                </div>
            </div>

            <!-- ç…§ç‰‡å±•ç¤ºåŒº -->
            <div class="photo-gallery">
                <h3>å­¦ä¹ è®°å½•ç…§ç‰‡</h3>
                <div id="photoGrid" class="photo-grid"></div>
            </div>
        </div>
    </div>

    <script>
        // æ–°å¢åˆ†é¡µåˆ‡æ¢é€»è¾‘
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰åˆ†é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            // ç§»é™¤æ‰€æœ‰æŒ‰é’®æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            // æ˜¾ç¤ºç›®æ ‡åˆ†é¡µå¹¶æ¿€æ´»æŒ‰é’®
            document.getElementById(`${tabName}Tab`).classList.add('active');
            document.getElementById(`${tabName}but`).classList.add('active');
            localStorage.setItem('lastActiveTab', tabName);
        }

        // é¡µé¢åŠ è½½æ—¶æ¢å¤
        window.onload = () => {
            const lastTab = localStorage.getItem('lastActiveTab') || 'camera';
            switchTab(lastTab);
        };
    </script>

    <script>
        let snapshots = [];  // å­˜å‚¨å½“å‰ä¼šè¯ä¸­çš„æ‰€æœ‰å¿«ç…§æ–‡ä»¶å

        // æ‹ç…§åŠŸèƒ½
        async function captureSnapshot() {
            try {
                const response = await fetch('/capture', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    snapshots.push(data.filename);
                    updateSnapshotList();
                } else {
                    alert(`æ‹ç…§å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        // æ›´æ–°å³ä¾§åˆ—è¡¨
        function updateSnapshotList() {
            const list = document.getElementById('snapshotList');
            list.innerHTML = snapshots.map(filename => `
                <div class="snapshot-item" onclick="previewSnapshot('${filename}')">
                    <img src="/static/snapshots/${filename}" alt="${filename}">
                </div>
            `).join('');
        }

        // é¢„è§ˆå•å¼ å¿«ç…§
        function previewSnapshot(filename) {
            document.getElementById('latestSnapshot').src = `/static/snapshots/${filename}`;
            document.getElementById('latestSnapshot').style.display = 'block';
        }

        // ç”ŸæˆPDF
        async function downloadPDF() {
            if (snapshots.length === 0) {
                alert('è¯·å…ˆæ‹ç…§ï¼');
                return;
            }

            try {
                const response = await fetch('/generate_pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filenames: snapshots })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'ç”ŸæˆPDFå¤±è´¥');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'snapshots.pdf';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                alert('PDFä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }
    </script>

    <script>
        // å…¨å±€å˜é‡
        let timerInterval = null;
        let remainingSeconds = 0;

        // å¼€å§‹å€’è®¡æ—¶
        function startTimer() {
            const duration = parseInt(document.getElementById('timerDuration').value);
            if (isNaN(duration) || duration < 1) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç§’æ•°ï¼');
                return;
            }

            ledOff();
            playStart();

            // æ¸…é™¤æ—§è®¡æ—¶å™¨
            if (timerInterval) clearInterval(timerInterval);

            remainingSeconds = duration;
            updateTimerDisplay();

            // å¯åŠ¨å‰ç«¯å€’è®¡æ—¶æ˜¾ç¤º
            timerInterval = setInterval(() => {
                remainingSeconds--;
                updateTimerDisplay();
                if (remainingSeconds <= 0) {
                    clearInterval(timerInterval);
                    ledOn();
                    playEnd();
                }
            }, 1000);
        }

        // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
        function updateTimerDisplay() {
            const minutes = Math.floor(remainingSeconds / 60).toString().padStart(2, '0');
            const seconds = (remainingSeconds % 60).toString().padStart(2, '0');
            document.getElementById('timerDisplay').textContent = `${minutes}:${seconds}`;
        }

        function playStart(){
            fetch('/play_timer_start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ })
            }).then(response => response.json())
            .then(data => {
                if (!data.success) alert('æ’­æ”¾å¤±è´¥: ' + data.error);
            });
        }
        function playEnd(){
            fetch('/play_timer_end', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ })
            }).then(response => response.json())
            .then(data => {
                if (!data.success) alert('æ’­æ”¾å¤±è´¥: ' + data.error);
            });
        }

        function ledOff() {
            fetch('/toggle_led', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ state: 'off' })
            }).then(response => response.json())
            .then(data => {
                if (!data.success) alert('å¼€ç¯å¤±è´¥: ' + data.error);
            });
        }

        // å€’è®¡æ—¶ç»“æŸåè§¦å‘å¼€ç¯
        function ledOn() {
            fetch('/toggle_led', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ state: 'on' })
            }).then(response => response.json())
            .then(data => {
                if (!data.success) alert('å¼€ç¯å¤±è´¥: ' + data.error);
            });
        }

        // é‡ç½®
        function manualToggleLed() {
            // const isOn = document.getElementById('timerDisplay').textContent !== '00:00';
            fetch('/toggle_led', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // body: JSON.stringify({ state: isOn ? 'off' : 'on' })
                body: JSON.stringify({ state: 'off' })
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    // alert(`ç¯å·²${isOn ? 'å…³é—­' : 'æ‰“å¼€'}`);
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + data.error);
                }
            });
        }
    </script>

    <script>
        // åˆå§‹åŒ–åŠ è½½æ’­æ”¾åˆ—è¡¨
        loadMusicList();
        setInterval(updateStatus, 1000);  // æ¯ç§’æ›´æ–°çŠ¶æ€

        // åŠ è½½éŸ³ä¹åˆ—è¡¨
        async function loadMusicList() {
            try {
                const response = await fetch('/music/list');
                const data = await response.json();
                if (data.success) {
                    renderMusicList(data.files);
                }
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“æ’­æ”¾åˆ—è¡¨
        function renderMusicList(files) {
            const container = document.getElementById('musicList');
            container.innerHTML = files.map(file => `
                <div class="track-item" onclick="playTrack('${file}')">
                    ${file}
                </div>
            `).join('');
        }

        // æ§åˆ¶æŒ‡ä»¤å‘é€
        async function control(action, extraData = {}) {
            console.log(action);
            const response = await fetch('/music/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action, ...extraData })
            });
            const data = await response.json();
            if (!data.success) alert(data.error);
        }

        // æ’­æ”¾æŒ‡å®šæ›²ç›®
        function playTrack(filename) {
            control('play_track', { file: filename });
        }

        // è®¾ç½®éŸ³é‡
        async function setVolume(value) {
            await fetch('/music/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    action: 'volume',
                    value: parseFloat(value)
                })
            });
        }

        // æ›´æ–°æ’­æ”¾çŠ¶æ€
        async function updateStatus() {
            const response = await fetch('/music/status');
            const data = await response.json();
            document.getElementById('currentTrack').textContent = 
                data.current_track || 'æ— ';
            document.getElementById('playStatus').textContent = 
                data.is_playing ? 'æ’­æ”¾ä¸­' : 'å·²æš‚åœ/åœæ­¢';
            document.getElementById('volume').value = data.volume;
        }

        // ä¸Šä¼ éŸ³ä¹
        async function uploadMusic() {
            const fileInput = document.getElementById('musicUpload');
            if (fileInput.files.length === 0) {
                alert('è¯·é€‰æ‹©éŸ³ä¹æ–‡ä»¶');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch('/music/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.success) {
                    await loadMusicList();
                    alert('ä¸Šä¼ æˆåŠŸï¼');
                } else {
                    alert('ä¸Šä¼ å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }
    </script>

    <script>
        // åˆå§‹åŒ–åŠ è½½ç…§ç‰‡
        loadStudyPhotos();
        setInterval(loadStudyPhotos, 5000); // æ¯5ç§’åˆ·æ–°

        // åŠ è½½ç…§ç‰‡åˆ—è¡¨
        async function loadStudyPhotos() {
            try {
                const response = await fetch('/study/photos');
                const data = await response.json();
                if (data.success) {
                    renderPhotos(data.photos);
                }
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“ç…§ç‰‡ç½‘æ ¼
        function renderPhotos(photos) {
            const container = document.getElementById('photoGrid');
            container.innerHTML = photos.map(photo => `
                <div class="photo-item">
                    <img src="/static/study_records/${photo}" 
                        onclick="showFullImage('${photo}')">
                    <div class="photo-date">
                        ${parseDateFromFilename(photo)}
                    </div>
                </div>
            `).join('');
        }

        // è§£ææ–‡ä»¶åä¸­çš„æ—¶é—´æˆ³
        function parseDateFromFilename(filename) {
            const ts = filename.split('_')[1];
            const year = ts.slice(0,4);
            const month = ts.slice(4,6);
            const day = ts.slice(6,8);
            const time = ts.slice(9,15).replace(/(..)/g, '$1:').slice(0,-1);
            return `${year}-${month}-${day} ${time}`;
        }

        // è®¾ç½®é—´éš”æ—¶é—´
        async function setsetInterval() {
            const interval = document.getElementById('intervalInput').value;
            const response = await fetch('/study/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action: 'set_interval',
                    interval: parseInt(interval)
                })
            });
            const data = await response.json();
            if (data.success) {
                alert('é—´éš”æ—¶é—´è®¾ç½®æˆåŠŸ');
            } else {
                alert('è®¾ç½®å¤±è´¥: ' + data.error);
            }
        }

        // åˆ‡æ¢å®šæ—¶çŠ¶æ€
        async function toggleCapture() {
            const response = await fetch('/study/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'toggle_capture' })
            });
            const data = await response.json();
            if (data.success) {
                const btn = document.getElementById('toggleBtn');
                btn.textContent = data.enabled ? 'åœæ­¢å®šæ—¶' : 'å¼€å¯å®šæ—¶';
                document.getElementById('captureStatus').textContent = 
                    data.enabled ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
            }
        }

        // ç«‹å³æ‹ç…§
        async function captureNow() {
            const response = await fetch('/study/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'capture_now' })
            });
            if (response.ok) {
                setTimeout(loadStudyPhotos, 1000); // 1ç§’ååˆ·æ–°
            }
        }

        // æ˜¾ç¤ºå¤§å›¾ï¼ˆéœ€æ·»åŠ æ¨¡æ€æ¡†ç»„ä»¶ï¼‰
        function showFullImage(filename) {
            window.open(`/static/study_records/${filename}`, '_blank');
        }
    </script>

    <script>
        // çŠ¶æ€æ›´æ–°å®šæ—¶å™¨
        let statusInterval = null;

        // æ§åˆ¶ç•ªèŒ„æ—¶é’Ÿ
        async function controlPomodoro(action) {
            const response = await fetch('/pomodoro/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: action })
            });
            
            if (action === 'start') {
                startStatusUpdates();
            } else if (action === 'pause') {
                clearInterval(statusInterval);
            }
        }

        // å¯åŠ¨çŠ¶æ€è½®è¯¢
        function startStatusUpdates() {
            clearInterval(statusInterval);
            statusInterval = setInterval(updateStatusDisplay, 1000);
        }

        // æ›´æ–°ç•Œé¢æ˜¾ç¤º
        async function updateStatusDisplay() {
            const response = await fetch('/pomodoro/status');
            const data = await response.json();
            
            // æ—¶é—´æ ¼å¼åŒ–
            const minutes = Math.floor(data.remaining / 60).toString().padStart(2, '0');
            const seconds = (data.remaining % 60).toString().padStart(2, '0');
            document.getElementById('timeDisplay').textContent = `${minutes}:${seconds}`;
            
            // çŠ¶æ€æŒ‡ç¤º
            const phaseMap = {
                'working': 'ä¸“æ³¨æ—¶é—´ ğŸ¯',
                'break': 'ä¼‘æ¯æ—¶é—´ â˜•'
            };
            document.getElementById('phaseIndicator').textContent = 
                data.status ? phaseMap[data.status] : 'å‡†å¤‡å¼€å§‹';
            
            // ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('tomatoCount').textContent = data.total_tomatoes;
            document.getElementById('cycleCount').textContent = data.cycles;
            
            // åŠ¨æ€é¢œè‰²
            const timeDisplay = document.getElementById('timeDisplay');
            timeDisplay.style.color = data.status === 'working' ? '#e74c3c' : '#2ecc71';
        }

        // ä¿å­˜è®¾ç½®
        async function saveSettings() {
            const work = document.getElementById('workTime').value;
            const breakTime = document.getElementById('breakTime').value;
            
            await fetch('/pomodoro/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action: 'set_duration',
                    work: work,
                    break: breakTime
                })
            });
            alert('è®¾ç½®å·²ä¿å­˜ï¼');
        }

        // åˆå§‹åŠ è½½
        updateStatusDisplay();
    </script>

    <!-- æäº¤è„šæœ¬ -->
    <script>
        let currentAssignment = null;

        var currentHomeworkList = null;

        // ç½‘ç»œå­¦å ‚ç™»å½•
        async function eduLogin() {
            const username = document.getElementById('eduUser').value;
            const password = document.getElementById('eduPass').value;
            
            const response = await fetch('/edu/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username, password })
            });
            
            const data = await response.json();
            if (data.success) {
                showLoginStatus('ç™»å½•æˆåŠŸ', 'success');
                loadAssignments();
            } else {
                showLoginStatus(`ç™»å½•å¤±è´¥: ${data.error}`, 'error');
            }
        }

        // åŠ è½½ä½œä¸šåˆ—è¡¨
        async function loadAssignments() {
            const response = await fetch('/edu/assignments');
            const data = await response.json();
            
            currentHomeworkList = data.assignments;
            if (data.success) {
                renderAssignments(data.assignments);
            } else {
                showLoginStatus(`è·å–ä½œä¸šå¤±è´¥: ${data.error}`, 'error');
            }
        }

        // æ¸²æŸ“ä½œä¸šåˆ—è¡¨
        function renderAssignments(assignments) {
            const container = document.querySelector('#assignmentList .list-container');
            container.innerHTML = assignments.map(assn => `
                <div class="assignment-item" 
                    onclick="selectAssignment('${assn.xszyid}', this)"
                    data-id="${assn.xszyid}">
                    <h4>${assn.bt}</h4>
                    <p>è¯¾ç¨‹ï¼š${assn.kcm}</p>
                    <p>æˆªæ­¢æ—¶é—´ï¼š${assn.jzsjStr}</p>
                </div>
            `).join('');
        }

        // é€‰æ‹©ä½œä¸š
        function selectAssignment(id, element) {
            currentAssignment = id;
            document.querySelectorAll('.assignment-item').forEach(item => {
                item.classList.remove('selected');
            });
            element.classList.add('selected');
        }

        // æäº¤ä½œä¸š
        async function submitAssignment() {
            if (!currentAssignment) {
                showSubmitStatus('è¯·å…ˆé€‰æ‹©ä½œä¸š', 'error');
                return;
            }

            const formData = new FormData();
            const nowAssignment=currentHomeworkList.find(item=>item.xszyid===currentAssignment);
            formData.append('assignment', JSON.stringify(nowAssignment));

            try {
                const response = await fetch('/edu/submit', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.success) {
                    showSubmitStatus('æäº¤æˆåŠŸ', 'success');
                } else {
                    showSubmitStatus(`æäº¤å¤±è´¥: ${data.error}`, 'error');
                }
            } catch (error) {
                showSubmitStatus(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // çŠ¶æ€æç¤ºå‡½æ•°
        function showLoginStatus(msg, type) {
            const el = document.getElementById('loginStatus');
            el.textContent = msg;
            el.className = `status-${type}`;
        }

        function showSubmitStatus(msg, type) {
            const el = document.getElementById('submitStatus');
            el.textContent = msg;
            el.className = `status-${type}`;
        }
    </script>
    
</body>
</html>
